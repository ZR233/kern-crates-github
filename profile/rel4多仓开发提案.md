# 多仓库开发简单规范

> 下面是一种将多个仓库合成一个 git 仓库并通过 CI 分发到不同仓库的方法。

## 为什么我们需要这种方法？

首先描述一下我们使用这种方法的背景：

1. 我们希望将整个系统拆分成多个细粒度的模块；
2. 我们希望每个功能和逻辑上独立的模块单独存在于一个 git 仓库中；
3. 我们希望每个模块都有独立的开发过程；
4. 我们希望每个模块都有独立的维护者（努力中）。

这导致我们我们的系统中会有非常多的模块，由于我们是整个系统的开发者，在面临四到五个模块进行开发时就会有些力不从心，简要描述一下我们面临的问题。

1. 整个系统中模块的数量过多，导致我们进行开发比较困难，提交和代码的 merge、pr 都需要处理很多个仓库；
2. 如果整个系统需要合并的时候，有些模块已经合并了，但是有些模块没有合并，对整个系统的测试就会比较困难；
3. 我们的工作正处于早期阶段，模块的组织结构可能会出现比较大的变动，对于模块的修改会比较多，会比较经常遇到上述问题；
4. 我们采用 Github project 作为我们的沟通和组织方式，但是出现当整个系统的某一个变动涉及多个模块中，project 中比较方便绑定到一个仓库中。

简要来说，就是整个系统的开发人员更注重整个系统的开发，分为多个模块会导致系统的开发人员花比较大的精力在 Git 仓库的 PR 和 Merge 上。对于没有经历过多仓库开发培训和学习的开发者来说，这个过程会更加困难和痛苦。

因此我们提出这个方法来缓解这个问题，但是我们也不是完全放弃了将模块放在单独的 Git 仓库中，在我们开发过程中发现模块已经比较稳定（长时间无大量修改且半数以上系统维护者同意），就可以在系统主仓库中移出此模块，通过 Git 链接引入，只在单独的仓库中维护此模块。

## 引入独立模块

以 rel4kernel 为例，我们现在有 rel4_kernel，sel4_c_impl，cspace,vspace,ipc,task,common 等多个仓库，我们可以找一个中心仓库，我们也可以新建一个仓库，下面新建一个仓库 rel4。

```shell
mkdir rel4
git init .
cd rel4
touch README.md
git add . && git commit -m "Repo Init"
git subrepo clone https://github.com/rel4team/rel4_kernel -b mi_dev
```

然后输入 `tree .` 能够看到下面的目录结构

```plain
.
└── rel4_kernel
    └── src
        ├── arch
        │   ├── aarch64
        │   │   └── arm_gic
        │   │       ├── gic_v2
        │   │       └── gic_v3
        │   └── riscv
        ├── boot
        ├── interfaces_impl
        ├── interrupt
        ├── kernel
        ├── object
        └── syscall
            └── invocation
                └── decode
                    └── arch
```

其他仓库的同样按照 `git subrepo clone xxx` 方式引入，如果需要指定分支，使用 `-b branch` 指定。

然后我们就可以按照单仓库的开发方式进行开发，且合并皆在一个仓库中。当我们需要将模块分发到独立的仓库中时，可调用 `git subrepo push`，即可更新远程仓库，如果远程仓库需要更新，则调用 `git subrepo pull` 更新本地目录。如果遇到冲突，则需要开发者手动按照 Git 方式合并。

模块的 `push` 可以作为 `ci` 进行处理，而 `pull` 需要系统开发者自己执行，如果遇到冲突，由内核开发者自己解决。

## 模块维护者的职责

1. 维护单独模块仓库
2. 通过单独模块的 CI

## 系统开发者的职责

1. 维护系统的模块
2. 如果遇到冲突，则需要系统开发者解决冲突和维护与远程模块的映射
3. 协助单独模块的合并

## 备注

1. 如果同时是系统开发者和模块维护者，则同时兼顾两种职责；
2. 在哪位开发者提交的时候出现与远程模块出现冲突，由此次提交的系统维护者处理。
